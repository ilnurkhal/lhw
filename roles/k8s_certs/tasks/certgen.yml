---
- name: Create a temp directory if it does not exist
  run_once: True
  local_action:
    module: file
    path: "{{ tmp_data_dir }}"
    state: directory
    mode: '0755'

- name: render ca-csr.json
  run_once: True
  local_action:
    module: template
    src: ca-csr.j2
    dest: "{{ tmp_data_dir }}/ca-csr.json"
  
- name: render ca-config.json
  run_once: True
  local_action:
    module: template
    src: ca-config.j2
    dest: "{{ tmp_data_dir }}/ca-config.json"

- name: render admin-csr.json
  run_once: True
  local_action:
    module: template
    src: admin-csr.j2
    dest: "{{ tmp_data_dir }}/admin-csr.json"

- name: render kube-controller-manager-csr.json
  run_once: True
  local_action:
    module: template
    src: kube-controller-manager-csr.j2
    dest: "{{ tmp_data_dir }}/kube-controller-manager-csr.json"

- name: render kube-proxy-csr.json
  run_once: True
  local_action:
    module: template
    src: kube-proxy-csr.j2
    dest: "{{ tmp_data_dir }}/kube-proxy-csr.json"

- name: render kube-scheduler-csr.json
  run_once: True
  local_action:
    module: template
    src: kube-scheduler-csr.j2
    dest: "{{ tmp_data_dir }}/kube-scheduler-csr.json"

- name: render kubernetes-csr.json
  run_once: True
  local_action:
    module: template
    src: kubernetes-csr.j2
    dest: "{{ tmp_data_dir }}/kubernetes-csr.json"
    
- name: render The Kubelet Client csr
  run_once: True
  local_action:
    module: template
    src: instance-csr.j2
    dest: "{{ tmp_data_dir }}/{{ item }}-csr.json"
  with_items: "{{ groups['k8s_worker'] }}"

- name: render service-account-csr.json
  run_once: True
  local_action:
    module: template
    src: service-account-csr.j2
    dest: "{{ tmp_data_dir }}/service-account-csr.json"

- name: Generate CA cert
  run_once: True
  delegate_to: 127.0.0.1
  shell: > 
    cfssl gencert -initca {{ tmp_data_dir }}/ca-csr.json | 
    cfssljson -bare {{ tmp_data_dir }}/ca

- name: Generate The Admin Client Certificate
  run_once: True
  delegate_to: 127.0.0.1
  shell: > 
    cfssl gencert -ca={{ tmp_data_dir }}/ca.pem 
    -ca-key={{ tmp_data_dir }}/ca-key.pem 
    -config={{ tmp_data_dir }}/ca-config.json 
    -profile=kubernetes  {{ tmp_data_dir }}/admin-csr.json | 
    cfssljson -bare {{ tmp_data_dir }}/admin

- name: Generate The Kubelet Client Certificates
  delegate_to: 127.0.0.1
  when: groups['k8s_worker'] is defined and inventory_hostname in groups['k8s_worker']
  shell: >
    cfssl gencert -ca={{ tmp_data_dir }}/ca.pem 
    -ca-key={{ tmp_data_dir }}/ca-key.pem 
    -config={{ tmp_data_dir }}/ca-config.json 
    -profile=kubernetes 
    -hostname={{ inventory_hostname_short }} {{ tmp_data_dir }}/{{ inventory_hostname_short }}-csr.json | 
    cfssljson -bare {{ tmp_data_dir }}/{{ inventory_hostname_short }}


- name: Generate The Controller Manager Client Certificate
  run_once: True
  delegate_to: 127.0.0.1
  shell: >
    cfssl gencert -ca={{ tmp_data_dir }}/ca.pem 
    -ca-key={{ tmp_data_dir }}/ca-key.pem 
    -config={{ tmp_data_dir }}/ca-config.json 
    -profile=kubernetes {{ tmp_data_dir }}/kube-controller-manager-csr.json | 
    cfssljson -bare {{ tmp_data_dir }}/kube-controller-manager

- name: Generate The Kube Proxy Client Certificate
  run_once: True
  delegate_to: 127.0.0.1
  shell: >
    cfssl gencert -ca={{ tmp_data_dir }}/ca.pem 
    -ca-key={{ tmp_data_dir }}/ca-key.pem 
    -config={{ tmp_data_dir }}/ca-config.json 
    -profile=kubernetes {{ tmp_data_dir }}/kube-proxy-csr.json | 
    cfssljson -bare {{ tmp_data_dir }}/kube-proxy

- name: Generate The Scheduler Client Certificate
  run_once: True
  delegate_to: 127.0.0.1
  shell: > 
    cfssl gencert -ca={{ tmp_data_dir }}/ca.pem 
    -ca-key={{ tmp_data_dir }}/ca-key.pem 
    -config={{ tmp_data_dir }}/ca-config.json 
    -profile=kubernetes {{ tmp_data_dir }}/kube-scheduler-csr.json | 
    cfssljson -bare {{ tmp_data_dir }}/kube-scheduler

- name: Generate The Kubernetes API Server Certificate
  run_once: True
  delegate_to: 127.0.0.1
  shell: > 
    cfssl gencert -ca={{ tmp_data_dir }}/ca.pem 
    -ca-key={{ tmp_data_dir }}/ca-key.pem 
    -config={{ tmp_data_dir }}/ca-config.json
    -hostname={{kubernetes_hostnames}},127.0.0.1,10.32.0.1,{{ groups['k8s_control_plane'] | list | join(',') }} 
    -profile=kubernetes {{ tmp_data_dir }}/kubernetes-csr.json | 
    cfssljson -bare {{ tmp_data_dir }}/kubernetes

- name: Generate The Kubernetes Service Account Certificate
  run_once: True
  delegate_to: 127.0.0.1
  shell: > 
    cfssl gencert -ca={{ tmp_data_dir }}/ca.pem 
    -ca-key={{ tmp_data_dir }}/ca-key.pem 
    -config={{ tmp_data_dir }}/ca-config.json 
    -profile=kubernetes {{ tmp_data_dir }}/service-account-csr.json | 
    cfssljson -bare {{ tmp_data_dir }}/service-account


- name: Distribute workers Certificates
  copy:
    src: "{{ tmp_data_dir }}/{{ item }}"
    dest: ~/
    remote_src: no
  when: groups['k8s_worker'] is defined and inventory_hostname in groups['k8s_worker']
  with_items:
  - "ca.pem" 
  - "{{ inventory_hostname }}-key.pem"
  - "{{ inventory_hostname }}.pem"

- name: Distribute controlplane Certificates
  copy:
    src: "{{ tmp_data_dir }}/{{ item }}"
    dest: ~/
    remote_src: no
  when: groups['k8s_control_plane'] is defined and inventory_hostname in groups['k8s_control_plane']
  with_items:
  - ca.pem
  - ca-key.pem
  - kubernetes-key.pem
  - kubernetes.pem
  - service-account-key.pem
  - service-account.pem
...